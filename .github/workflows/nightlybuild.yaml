name: nightlybuild

# Triggers the workflow on push or pull request
# events but only for the master and develop branch
on:
  push:
    branches:
    - main
    - develop
  pull_request:
    branches:
    - main
    - develop

jobs:
  # The "build" workflow
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
    # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
    - uses: actions/checkout@v4
    
    # Setup Go
    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21.5' # The Go version to download (if necessary) and use.
        
    # Run build of the application
    - name: Run build windows
      run: cd app && GOOS=windows GOARCH=amd64 go build -o ../dist/codeshell-win64.exe main.go 
    - name: Run build linux
      run: cd app && GOOS=linux GOARCH=amd64 go build -o ../dist/codeshell-linux64 main.go 
    
    # Run testing on the code
    - name: Run testing
      run: cd app && go test -v ./...

    - uses: actions/upload-artifact@v4
      with:
        name: codeshell-latest
        path: dist/    
        retention-days: 7
        overwrite: true

  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
        
    needs: build

    steps: 
        - uses: actions/download-artifact@v4
          with:
            path: artifact
            pattern: codeshell-latest*
        - uses: ncipollo/release-action@v1
          with:
            artifacts: codeshell-latest
            name: codeshell-latest.zip
            allowUpdates: true
            prerelease: true
            tag: latest-build
            


  # The "deploy" workflow
#  deploy:
    # The type of runner that the job will run on
#    runs-on: ubuntu-latest
#    needs: [build] # Only run this workflow when "build" workflow succeeds
#    if: ${{ github.ref == 'refs/heads/master' && github.event_name == 'push' }} # Only run this workflow if it is master branch on push event
#    steps:
#    - uses: actions/checkout@v2

    # Deploy to Docker registry
#    - name: Deploy to Docker registry
#      uses: docker/build-push-action@v1
#      with:
 #       username: ${{ secrets.DOCKER_USERNAME }}
 #       password: ${{ secrets.DOCKER_PASSWORD }}
 #       repository: wilsontanwm/gosimple
 #       tag_with_ref: true